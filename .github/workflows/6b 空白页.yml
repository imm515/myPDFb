name: 6b Merge to A4 PDF

on:
  workflow_dispatch:
    inputs:
      dpi_setting:
        description: 'è¾“å‡ºDPIè®¾ç½® (å»ºè®®72-300)'
        required: false
        default: '150'

jobs:
  pdf-merger:
    runs-on: ubuntu-latest
    env:
      SOURCE_DIR: ${{ secrets.PRIVATE_DIR }}/3æŸ¥æ‰¾
      OUTPUT_DIR: ${{ secrets.PRIVATE_DIR }}/4æ‹¼æŽ¥PDF

    steps:
      - name: Checkout private repo
        uses: actions/checkout@v4
        with:
          repository: ${{ secrets.PRIVATE_REPO }}
          token: ${{ secrets.PAT }}
          path: private-repo
          ref: main

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libjpeg-dev zlib1g-dev
          pip install Pillow reportlab

      - name: Prepare workspace
        run: |
          cd private-repo
          mkdir -p "$OUTPUT_DIR"
          echo "DPI: ${{ github.event.inputs.dpi_setting }}" > merge.log

      - name: Merge images to A4 PDF
        run: |
          cd private-repo
          python3 <<EOF
          import os
          import math
          from PIL import Image
          from reportlab.pdfgen import canvas
          from reportlab.lib.pagesizes import A4
          from reportlab.lib.utils import ImageReader
          import re

          # é…ç½®å‚æ•°
          DPI = int("${{ github.event.inputs.dpi_setting }}")
          A4_WIDTH, A4_HEIGHT = A4
          MM_TO_POINT = 2.83465
          PAGE_WIDTH = A4_WIDTH * MM_TO_POINT
          PAGE_HEIGHT = A4_HEIGHT * MM_TO_POINT
          SECTION_HEIGHT = PAGE_HEIGHT / 3
          MARGIN = 10

          # èŽ·å–æŽ’åºåŽçš„æ–‡ä»¶åˆ—è¡¨
          def natural_sort_key(s):
              return [int(text) if text.isdigit() else text.lower()
                      for text in re.split(r'(\d+)', os.path.basename(s))]

          all_files = []
          for root, _, files in os.walk(os.getenv("SOURCE_DIR")):
              for f in files:
                  if f.lower().endswith('.png'):
                      all_files.append(os.path.join(root, f))
          all_files.sort(key=natural_sort_key)

          # åˆ›å»ºPDF
          output_path = os.path.join(os.getenv("OUTPUT_DIR"), "merged.pdf")
          c = canvas.Canvas(output_path, pagesize=(PAGE_WIDTH, PAGE_HEIGHT))

          # ä¿®æ­£åŽçš„åˆ†é¡µé€»è¾‘
          for i in range(0, len(all_files)):
              # æ¯3ä¸ªå›¾ç‰‡å¼€å§‹æ–°é¡µï¼ˆé™¤ç¬¬ä¸€é¡µå¤–ï¼‰
              if i % 3 == 0 and i != 0:
                  c.showPage()
              
              # èŽ·å–å½“å‰sectionç´¢å¼•ï¼ˆ0-2ï¼‰
              section = i % 3
              img_path = all_files[i]
              
              try:
                  img = Image.open(img_path)
                  img_reader = ImageReader(img)
                  
                  # è®¡ç®—ç¼©æ”¾
                  img_width, img_height = img.size
                  target_width = PAGE_WIDTH - 2*MARGIN
                  target_height = SECTION_HEIGHT - 2*MARGIN
                  scale = min(target_width/img_width, target_height/img_height)
                  new_width = img_width * scale
                  new_height = img_height * scale
                  
                  # è®¡ç®—ä½ç½®
                  x = (PAGE_WIDTH - new_width)/2
                  y = PAGE_HEIGHT - (section+1)*SECTION_HEIGHT + (SECTION_HEIGHT - new_height)/2
                  
                  c.drawImage(img_reader, x, y, new_width, new_height)
              except Exception as e:
                  print(f"å¤„ç†å¤±è´¥ï¼š{img_path} - {str(e)}")
              
              # è¡¥å……å½“å‰é¡µçš„ç©ºç™½åŒºåŸŸ
              if (i == len(all_files)-1) and (section < 2):
                  for s in range(section+1, 3):
                      c.setStrokeColorRGB(0.8, 0.8, 0.8)
                      c.setLineWidth(0.5)
                      y_pos = PAGE_HEIGHT - (s+1)*SECTION_HEIGHT
                      c.rect(MARGIN, y_pos + MARGIN, 
                            PAGE_WIDTH - 2*MARGIN, SECTION_HEIGHT - 2*MARGIN)

          # ä¿å­˜PDF ðŸ‘‰ ä¸éœ€è¦é¢å¤–showPage()
          c.save()
          EOF

      - name: Commit results
        run: |
          cd private-repo
          git config user.email "pdf-merger@auto"
          git config user.name "PDF Merger"

          # ç”Ÿæˆç‰ˆæœ¬å·
          timestamp=$(date +%Y%m%d%H%M%S)
          commit_msg="Auto: ç”Ÿæˆæ‹¼æŽ¥PDFï¼ˆv$timestampï¼‰"

          git add "$OUTPUT_DIR"
          git commit -m "$commit_msg"
          git push "https://x-access-token:${{ secrets.PAT }}@github.com/${{ secrets.PRIVATE_REPO }}.git" main
